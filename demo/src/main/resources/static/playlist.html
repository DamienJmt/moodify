<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestion des Playlists</title>

  <link rel="stylesheet" href="/css/style.css" />
  <style>
    .playlist-card { border:1px solid #ddd; padding:12px; border-radius:10px; margin:10px 0; background:#fff; }
    .playlist-actions { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .playlist-actions button { padding:8px 12px; border-radius:8px; border:none; cursor:pointer; }
    .songs-list { margin-top:8px; }
    .song-item { display:flex; align-items:center; justify-content:space-between; padding:6px 8px; border-radius:8px; background:#f6f6f6; margin:6px 0; }
    .remove-song { cursor:pointer; font-weight:700; padding:0 8px; }
    .manage-panel { border:2px dashed #ccc; padding:12px; border-radius:12px; margin-top:16px; background:#fafafa; }
    .tag { display:inline-block; padding:2px 8px; margin:2px; border-radius:999px; background:#eee; font-size:12px; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <h1>üéµ Gestion des Playlists</h1>

  <div style="margin-bottom:12px;">
    <a th:href="@{/}" class="btn-playlists">‚Üê Retour au lecteur</a>
  </div>

  <section class="create-playlist">
    <h2>Cr√©er une playlist</h2>
    <form id="createPlaylistForm">
      <label>Nom :</label>
      <input type="text" id="playlistName" required />

      <label>Description :</label>
      <input type="text" id="playlistDescription" />

      <label>Humeurs :</label>
      <select id="playlistMoods" multiple>
        <option value="Happy">Happy</option>
        <option value="Romantic">Romantic</option>
        <option value="Angry">Angry</option>
        <option value="Calm">Calm</option>
        <option value="Chill">Chill</option>
        <option value="Sad">Sad</option>
        <option value="Energetic">Energetic</option>
      </select>

      <button type="submit">Cr√©er</button>
    </form>
  </section>

  <section class="playlists-list">
    <h2>Playlists existantes</h2>
    <div id="playlistsContainer"></div>
  </section>

  <section id="managePanel" class="manage-panel hidden">
    <h2 id="manageTitle">Playlist</h2>
    <p id="manageDescription"></p>
    <div id="manageMoods"></div>

    <div class="songs-list">
      <h3>Musiques dans la playlist</h3>
      <div id="songsContainer"></div>
    </div>

    <div style="margin-top:10px;">
      <button id="showAddSongBtn">Ajouter une musique</button>
      <div id="addSongBox" class="hidden" style="margin-top:8px;">
        <select id="candidateSongsSelect"></select>
        <button id="addSelectedSongBtn">Ajouter</button>
      </div>
    </div>
  </section>

  <script>
    const playlistsContainer = document.getElementById("playlistsContainer");
    const managePanel = document.getElementById("managePanel");
    const manageTitle = document.getElementById("manageTitle");
    const manageDescription = document.getElementById("manageDescription");
    const manageMoods = document.getElementById("manageMoods");
    const songsContainer = document.getElementById("songsContainer");
    const showAddSongBtn = document.getElementById("showAddSongBtn");
    const addSongBox = document.getElementById("addSongBox");
    const candidateSelect = document.getElementById("candidateSongsSelect");
    const addSelectedSongBtn = document.getElementById("addSelectedSongBtn");

    let currentPlaylistId = null;

    // ‚úÖ FIX compat luca/refonte : artists peut √™tre string, array, ou absent
    function artistsText(s) {
      if (s.artist) return s.artist; // nouveau mod√®le
      if (Array.isArray(s.artists)) return s.artists.join(", "); // ancien mod√®le array
      if (typeof s.artists === "string") return s.artists; // ancien mod√®le string
      return "";
    }

    async function loadPlaylists() {
      const res = await fetch("/api/playlists");
      const playlists = await res.json();

      playlistsContainer.innerHTML = "";
      if (!playlists.length) {
        playlistsContainer.innerHTML = "<p>Aucune playlist pour le moment.</p>";
        return;
      }

      playlists.forEach(function(pl) {
        const div = document.createElement("div");
        div.className = "playlist-card";

        const moods = (pl.moods || []).map(function(m){ return '<span class="tag">' + m + '</span>'; }).join(" ");
        div.innerHTML =
          '<h3>' + pl.name + '</h3>' +
          '<p>' + (pl.description || "Aucune description") + '</p>' +
          '<div>' + (moods || "<em>Aucune humeur</em>") + '</div>' +
          '<p><strong>Musiques :</strong> ' + ((pl.songs || []).length) + '</p>' +
          '<div class="playlist-actions">' +
            '<button onclick="openPlaylist(\'' + pl.id + '\')">Ouvrir</button>' +
            '<button onclick="deletePlaylist(\'' + pl.id + '\')">Supprimer</button>' +
          '</div>';

        playlistsContainer.appendChild(div);
      });
    }

    async function openPlaylist(id) {
      currentPlaylistId = id;
      const res = await fetch("/api/playlists/" + id);
      if (res.status === 404) return;
      const pl = await res.json();

      manageTitle.textContent = pl.name;
      manageDescription.textContent = pl.description || "";
      manageMoods.innerHTML = (pl.moods || []).map(function(m){ return '<span class="tag">' + m + '</span>'; }).join(" ");

      renderSongs(pl);
      await loadCandidates();

      managePanel.classList.remove("hidden");
      addSongBox.classList.add("hidden");
    }

    function renderSongs(pl) {
      songsContainer.innerHTML = "";
      const songs = pl.songs || [];
      if (!songs.length) {
        songsContainer.innerHTML = "<p>Aucune musique ajout√©e.</p>";
        return;
      }

      songs.forEach(function(s) {
        const item = document.createElement("div");
        item.className = "song-item";
        item.innerHTML =
          '<div>' +
            '<strong>' + (s.title || s.name) + '</strong>' +
            // ‚úÖ remplacement join -> artistsText
            '<span style="opacity:.7"> ‚Äî ' + artistsText(s) + '</span>' +
          '</div>' +
          '<div class="remove-song" title="Supprimer">‚úñ</div>';

        item.querySelector(".remove-song").addEventListener("click", async function() {
          if (!confirm("Supprimer cette musique de la playlist ?")) return;
          await fetch("/api/playlists/" + currentPlaylistId + "/songs/" + s.id, { method: "DELETE" });
          openPlaylist(currentPlaylistId);
          loadPlaylists();
        });

        songsContainer.appendChild(item);
      });
    }

    async function loadCandidates() {
      if (!currentPlaylistId) return;
      const res = await fetch("/api/playlists/" + currentPlaylistId + "/candidates");
      const candidates = await res.json();

      candidateSelect.innerHTML = "";
      if (!candidates.length) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "Aucune musique disponible pour ces humeurs";
        candidateSelect.appendChild(opt);
        candidateSelect.disabled = true;
        addSelectedSongBtn.disabled = true;
        return;
      }

      candidateSelect.disabled = false;
      addSelectedSongBtn.disabled = false;

      candidates.forEach(function(s) {
        const opt = document.createElement("option");
        opt.value = s.id;
        // ‚úÖ remplacement join -> artistsText
        opt.textContent = (s.title || s.name) + " - " + artistsText(s);
        candidateSelect.appendChild(opt);
      });
    }

    showAddSongBtn.addEventListener("click", async function() {
      addSongBox.classList.toggle("hidden");
      if (!addSongBox.classList.contains("hidden")) {
        await loadCandidates();
      }
    });

    addSelectedSongBtn.addEventListener("click", async function() {
      const songId = candidateSelect.value;
      if (!songId) return;
      await fetch("/api/playlists/" + currentPlaylistId + "/songs/" + songId, { method: "POST" });
      openPlaylist(currentPlaylistId);
      loadPlaylists();
    });

    async function deletePlaylist(id) {
      await fetch("/api/playlists/" + id, { method: "DELETE" });
      if (currentPlaylistId === id) {
        managePanel.classList.add("hidden");
        currentPlaylistId = null;
      }
      loadPlaylists();
    }

    document.getElementById("createPlaylistForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const name = document.getElementById("playlistName").value;
      const description = document.getElementById("playlistDescription").value;
      const moods = Array.from(document.getElementById("playlistMoods").selectedOptions)
        .map(function(o){ return o.value; });

      await fetch("/api/playlists", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name: name, description: description, moods: moods })
      });

      e.target.reset();
      loadPlaylists();
    });

    loadPlaylists();
  </script>
</body>
</html>
