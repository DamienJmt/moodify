<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Player</title>

    <!-- CSS -->
    <link rel="stylesheet" th:href="@{/css/style.css}">

    <!-- Iconify -->
    <script src="https://code.iconify.design/iconify-icon/1.0.8/iconify-icon.min.js"></script>
</head>
<body>

    <!-- Bouton pour changer le background -->
    <button id="changeBgBtn">Changer Background</button>

    <div class="tabs">
        <button class="tab active" data-target="tab-music">ðŸŽµ Musiques</button>
        <button class="tab" data-target="tab-playlists">ðŸ“‚ Playlists</button>
        <button class="tab" data-target="tab-moods">ðŸ˜Š Humeurs</button>
    </div>


    <!-- ONGLET MUSIQUES -->
    <div id="tab-music" class="tab-content visible">
        <select id="songSelector">
            <option value="">-- Choisir une chanson --</option>
        </select>
    </div>

    <!-- ONGLET PLAYLISTS -->
    <div id="tab-playlists" class="tab-content">
        <button id="openPlaylistsPage" class="btn-open-playlists">
            ðŸ“‚ Mes playlists
        </button>

        <div id="playlistsContainer"></div>
    </div>

    <!-- ONGLET HUMEURS -->
    <div id="tab-moods" class="tab-content">
        <select id="moodSelector">
            <option value="">-- Choisir une humeur --</option>
            <option value="Happy">Happy</option>
            <option value="Romantic">Romantic</option>
            <option value="Angry">Angry</option>
            <option value="Calm">Calm</option>
            <option value="Sad">Sad</option>
            <option value="Chill">Chill</option>
            <option value="Energetic">Energetic</option>
        </select>
    </div>


    <!-- Lecteur -->
    <div class="player">
        <div class="thumbnail">
            <img th:src="@{/images/default-thumb.png}" id="thumb" alt="Thumbnail">
        </div>
        <div class="details">
            <h3 id="title">Titre</h3>
            <span id="artist">Artiste</span>
            <div id="moods" class="moods"></div>
            <div id="metadata" class="metadata"></div>
            
        </div>
        <audio id="song">
            <source src="" type="audio/mp3">
        </audio>
        <div class="time">
            <span id="start">00:00</span>
            <span id="end">00:00</span>
        </div>
        <input type="range" class="progress-bar" id="progress" value="0" max="0">
        <div class="action">
            <button class="prev-play">
                <iconify-icon icon="iconoir:skip-prev-solid"></iconify-icon>
            </button>
            <button class="play" id="play">
                <iconify-icon icon="iconoir:play-solid" class="icon-play"></iconify-icon>
                <iconify-icon icon="iconoir:pause-solid" class="icon-pause hidden"></iconify-icon>
            </button>
            <button class="next-play">
                <iconify-icon icon="iconoir:skip-next-solid"></iconify-icon>
            </button>
        </div>

        <!-- Bloc volume sÃ©parÃ© -->
        <div class="volume-control">
            <p id="volumeLabel">Volume : 100%</p>
            <button id="volumeDown" title="Baisser le volume">
                <iconify-icon icon="iconoir:sound-low"></iconify-icon>
            </button>
            <button id="volumeUp" title="Augmenter le volume">
                <iconify-icon icon="iconoir:sound-high"></iconify-icon>
            </button>
        </div>

    </div>

    <!-- JS -->
    <script type="module" th:src="@{/js/script.js}"></script>
    <script type="module">
        // Fonction pour changer le background
        const changeBgBtn = document.getElementById("changeBgBtn");

        async function changeBackground() {
            try {
                const res = await fetch("/api/images");
                const images = await res.json();
                if (images.length === 0) return;

                const randomImage = images[Math.floor(Math.random() * images.length)];
                document.body.style.backgroundImage = `url('${randomImage}')`;
            } catch(err) {
                console.error("Erreur lors du changement de background:", err);
            }
        }
        
        let currentPlaylist = [];
        let currentSongIndex = 0;

            const playlistToPlay = localStorage.getItem("playlistToPlay");

            if (playlistToPlay) {
            const songs = JSON.parse(playlistToPlay);

            currentPlaylist = songs;
            currentSongIndex = 0;

            // Charger la premiÃ¨re chanson de la playlist
            const firstSong = currentPlaylist[currentSongIndex];

            const songElement = document.querySelector("#song");
            const titleElement = document.querySelector("#title");
            const artistElement = document.querySelector("#artist");
            const thumbElement = document.querySelector("#thumb");

            songElement.src = firstSong.link;
            titleElement.textContent = firstSong.name;
            artistElement.textContent = firstSong.artists;
            thumbElement.src = firstSong.image;

            // Jouer la musique
            songElement.play().catch(() => {});

            localStorage.removeItem("playlistToPlay");

    }

        changeBgBtn.addEventListener("click", changeBackground);

    </script>

</body>
</html>
